"use strict";var Pool=function(count,prefix,log_to_console,status){var that=this;this.queue=[];this.statusSetQueueLength(this.queue.length);this.task_id=0;this.callbacks=[];this.configureLogging(log_to_console);this.status=status;this.workers=[];var slavejs=(prefix?(prefix+"/"):"")+"slave_min.js";for(var i=0;i<count;++i){this.statusAddWorker(i);this.workers[i]=new Worker(slavejs);this.workers[i].addEventListener("message",Pool.makeMessageHandler(that,i),false);this.workers[i].addEventListener("error",Pool.makeErrorHandler(that,i),false);this.workers[i].postMessage({cmd:Pool.SET_ID,id:i});}
this.log("Pool created with "+count+" slaves");};Pool.prototype.postTask=function(task,callback){this.queue.push({task:task,callback:callback});if(this.queue.length==1){this.broadcastMessage({cmd:Pool.NEW_TASK});}
this.statusSetQueueLength(this.queue.length);};Pool.prototype.kill=function(){this.broadcastMessage({cmd:Pool.KILL});this.statusKill();};Pool.prototype.configureLogging=function(log_to_console){if(log_to_console){this.log=function(){console.debug.apply(console,arguments);}
this.warn=function(){console.warn.apply(console,arguments);}
this.error=function(){console.error.apply(console,arguments);}}else{this.log=function(){};this.warn=function(){};this.error=function(e){alert(e);};}};Pool.makeMessageHandler=function(that,i){return function(ev){that.handleMessage(ev,i);};}
Pool.makeErrorHandler=function(that,i){return function(ev){that.handleError(ev,i);};}
Pool.BUSY="busy";Pool.ERROR="error";Pool.IDLE="idle";Pool.KILL="kill";Pool.NEW_TASK="new_task";Pool.NO_TASK="no_task";Pool.REQUEST_TASK="request_task";Pool.SET_ID="set_id";Pool.START_TASK="start_task";Pool.TASK_RESULT="task_result";Pool.WORKER_CLOSED="worker_closed";Pool.prototype.handleMessage=function(ev,i){var data=ev.data;if(data.cmd){switch(data.cmd){case Pool.REQUEST_TASK:this.provideTask(i);break;case Pool.BUSY:this.statusSetBusy(i,true);break;case Pool.IDLE:this.statusSetBusy(i,false);break;case Pool.TASK_RESULT:this.receiveResults(data.id,data.result,i);break;case Pool.WORKER_CLOSED:this.statusRemoveWorker(i);break;case Pool.ERROR:this.receiveError(data.args,i);break;default:this.warn("Unknown command: "+data.cmd,data);}}else if(data.msg){this.log("Message from "+i+": ",data.msg);}else{this.log("Received from "+i,data);}};Pool.prototype.handleError=function(ev,i){this.error("Error from "+i+": ",ev);};Pool.prototype.postMessage=function(msg,i){var w=this.workers[i];if(w){w.postMessage(msg);}};Pool.prototype.broadcastMessage=function(msg){for(var i=0;i<this.workers.length;++i){this.postMessage(msg,i);}};Pool.prototype.provideTask=function(i){if(this.queue.length>0){var task_def=this.queue.shift();++this.task_id;this.callbacks[this.task_id]=task_def.callback;this.log("#"+i+" sending task",task_def.task);this.postMessage({cmd:Pool.START_TASK,id:this.task_id,task:task_def.task},i);this.statusSetQueueLength(this.queue.length);}else{this.log("#"+i+" no tasks available");this.postMessage({cmd:Pool.NO_TASK},i);}};Pool.prototype.receiveResults=function(id,result,i){if(id===undefined){this.warn("Unidentified task result from #"+i,result);return;}
var callback=this.callbacks[id];if(callback){this.callbacks[id]=null;callback.call(null,result);}};Pool.prototype.receiveError=function(err,i){this.error("#"+i+" ERROR: "+err.msg,err.exception);};Pool.prototype.workerClosed=function(i){this.workers[i]=null;this.statusRemoveWorker(i);};Pool.prototype.statusAddWorker=function(i){if(this.status){this.status.addWorker(i);}};Pool.prototype.statusRemoveWorker=function(i){if(this.status){this.status.removeWorker(i);}};Pool.prototype.statusSetBusy=function(i,busy){if(this.status){this.status.setBusy(i,busy);}};Pool.prototype.statusSetQueueLength=function(l){if(this.status){this.status.setQueueLength(l);}};Pool.prototype.statusKill=function(){if(this.status){this.status.kill();}};